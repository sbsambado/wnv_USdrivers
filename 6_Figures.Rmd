---
title: "6_Figures"
output: html_document
date: "2025-08-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## upload necessary packages
library(tigris)
library(sf)
library(terra)
library(cowplot)
library(paletteer)
library(ggpubr)
library(mgcv)
library(gratia)

```

Spatial boundaries
```{r}
## US county boundaries
counties_sf <- tigris::counties(year = 2020, cb = TRUE, class = "sf")


## US state boundaries
all_states_sf <- tigris::states(year = 2020, cb = TRUE, class = "sf") # for figures
states_sf <- all_states_sf[!all_states_sf$STUSPS %in% c("PR", "VI", "GU", "MP", "AS", "AK" ,"HI"), ] # omit territories

## US county centroid lat, lon
county_centroids <- st_centroid(counties_sf)
county_centroids$lon  <- st_coordinates(county_centroids)[,1]
county_centroids$lat  <- st_coordinates(county_centroids)[,2]
```

#Main Text

#Figure 1.

##Part A

Format data
```{r}

## read in % ag % urban data
nlcd_pct <- read.csv("data/processed/nlcd_urbanag_pct.csv")


## make spatial & create bins
nlcd_perc_spatial <- counties_sf %>% 
  left_join(nlcd_urbanag, by = "GEOID") %>% 
  # make new column for 3x3 binning category for figure
  mutate(urban_category = ntile(urban_pct, 3),
         ag_category = ntile(ag_pct, 3),
         bivariate_class = paste0(ag_category, "-", urban_category))

## make color palette
bivariate_pal <- c("1-1" = "#e8e8e8", "1-2" = "#ace4e4", "1-3" = "#5ac8c8",
                   "2-1" = "#dfb0d6", "2-2" = "#a5add3", "2-3" = "#5698b9",
                   "3-1" = "#be64ac", "3-2" = "#8c62aa", "3-3" = "#3b4994")

## make separate legend
# format data
bivarate_legend_df <- expand.grid(ag_cat = 1:3, # make 3x3 grid
                               urban_cat = 1:3) %>% 
  mutate(bivariate_class = paste0(ag_cat, "-", urban_cat),
         fill = bivariate_pal[bivariate_class])

# plot it
bivarate_legend <- ggplot(bivarate_legend_df, aes(x = urban_cat, y = ag_cat, fill = fill)) +
  geom_tile(color = "white") +
  scale_fill_identity() +
  coord_fixed() +
  theme_void() +
  labs(x = "More Urban →", y = "↑ More\nAg") +
  theme(axis.title = element_text(size = 15, face = "bold"))

```


plot it
```{r}

## base plot
fig_1_map <- ggplot() +
  geom_sf(data = nlcd_perc_spatial, aes(fill = bivariate_class), color = NA, size = 0.05,show.legend = TRUE) +
  scale_fill_manual(values = bivariate_pal) +
  coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -64), ylim = c(24, 50), expand = FALSE) +
  labs(title = "(a) % Agricultural vs % Urban Land") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        #legend.position = c(.15, .17),
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        
        plot.margin = margin(t = -5, r = -35, b = -7, l = 2)) +
  guides(fill = FALSE)

## add legend
fig_1_a <- ggdraw() +
  draw_plot(fig_1_map) +
  draw_plot(bivarate_legend, x = .0001, y = .023, width = .25, height = .25)
ggsave(fig_1_a, file = "output/figures/fig_1_a.png", width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")



```


##Part B
Upload & Format data
```{r}
## predicted mosquito overlap
gorris_pip <- terra::rast("data/raw/gorris_sdm/culex_pipiens_meansuitability.nc")
gorris_tar <- terra::rast("data/raw/gorris_sdm/culex_tarsalis_meansuitability.nc")
gorris_quin <- terra::rast("data/raw/gorris_sdm/culex_quinquefasciatus_meansuitability.nc")

## crop to CONUS
conus_extent <- ext(-125, -66.5, 24, 51)

conus_pip <- crop(gorris_pip, conus_extent)
conus_tar <- crop(gorris_tar, conus_extent)
conus_quin <- crop(gorris_quin, conus_extent)

## name each layer
names(conus_pip) <- "Cx. pipiens"
names(conus_tar) <- "Cx. tarsalis"
names(conus_quin) <- "Cx. quinquefasicatus"


## stack layers
conus_stack <- c(conus_pip, conus_tar, conus_quin)

# check
plot(conus_stack)

## add threshold of probability suitability to make more rigorous 
conus_threshold <- conus_stack >= 0.6

## create binary weighting to keep track which species are in which pixel
conus_binary <- conus_threshold[[1]] + # pipiens coded 0 or 1
  2*conus_threshold[[2]] + # tarsalis coded 0 or 2
  4*conus_threshold[[3]] # quinq coded 0 or 4


## finangle spatial boundary to be CONUS outline
conus_binary_reproj <- st_transform(counties_sf, crs(conus_binary))
conus_binary_mask <- mask(conus_binary, conus_binary_reproj)

# check
plot(conus_binary_mask)

## turn into dataframe for ggplot
conus_binary_df <- as.data.frame(conus_binary_mask, xy = TRUE, na.rm = TRUE)
colnames(conus_binary_df)[3] <- "species_code"


## assign names to binary codes
conus_binary_df <- conus_binary_df %>% 
  mutate(species_category = factor(species_code,
                                   levels = 0:7,
                                   labels = c("None",
                                              "Cx. pipiens",
                                              "Cx. tarsalis",
                                              "Cx. tarsalis & Cx. pipiens",
                                              "Cx. quinquefasciatus",
                                              "Cx. pipiens & Cx. quinq.",
                                              "Cx. tarsalis & Cx. quinq.",
                                              "All 3 species")))


mos_colors <- c("None" = "grey95",
                "Cx. pipiens" = "#ae2012",
                "Cx. tarsalis" = "#94d2bd",
                "Cx. quinquefasciatus" = "#009E73",#"#90be6d",
                
                "Cx. tarsalis & Cx. pipiens" = "#577590",
                "Cx. pipiens & Cx. quinq." = "#f9844a",
                "Cx. tarsalis & Cx. quinq." = "#005f73",
                
                "All 3 species" = "#f9c74f")

```

plot it
```{r}
fig_1_b <- ggplot() +
  geom_raster(data = conus_binary_df, aes(x = x, y = y, fill = species_category)) +
  scale_fill_manual(name = "Species Present",
                    values = mos_colors,
                    breaks = c("Cx. pipiens", "Cx. tarsalis", "Cx. quinquefasciatus",
                               "Cx. tarsalis & Cx. pipiens", "Cx. tarsalis & Cx. quinq.", "Cx. pipiens & Cx. quinq.",
                               "All 3 species"),
                    guide = guide_legend(nrow = 7)) +
  coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "(b) Overlap of Predicted Mosquito Species") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = c(.13, .17),
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        
        plot.margin = margin(t = -5, r = -35, b = -7, l = 2)) + 
  scale_x_continuous(expand = c(0, 0), limits = c(-125, -64)) +
  scale_y_continuous(expand = c(0, 0), limits = c(24, 50))

ggsave(fig_1_b, file = "output/figures/fig_1_b.png", width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")
```


#Figure 2


#Fig 3

Format data
```{r}

## upload dataframes
risk_pip_df <- read.csv("data/processed/temp/map_scaledrisk_245_hist_pip.csv")
risk_tar_df <- read.csv("data/processed/temp/map_scaledrisk_245_hist_tar.csv")
risk_quin_df <- read.csv("data/processed/temp/map_scaledrisk_245_hist_quin.csv")

mid_risk_pip_df <- read.csv("data/processed/temp/map_scaledrisk_245_mid_pip.csv")
mid_risk_tar_df <- read.csv("data/processed/temp/map_scaledrisk_245_mid_tar.csv")
mid_risk_quin_df <- read.csv("data/processed/temp/map_scaledrisk_245_mid_quin.csv")


late_risk_pip_df <- read.csv("data/processed/temp/map_scaledrisk_245_late_pip.csv")
late_risk_tar_df <- read.csv("data/processed/temp/map_scaledrisk_245_late_tar.csv")
late_risk_quin_df <- read.csv("data/processed/temp/map_scaledrisk_245_late_quin.csv")

## make max values for scaled risk
scaled_risk_max_abs <- max(abs(risk_pip_df$scaled_risk), 
                           abs(risk_tar_df$scaled_risk), 
                           abs(risk_quin_df$scaled_risk))


## calculate difference from current to mid century
# pip
diff_midcurrent_pip <- risk_pip_df
diff_midcurrent_pip$change <- mid_risk_pip_df$scaled_risk  - risk_pip_df$scaled_risk

#tar
diff_midcurrent_tar <- risk_tar_df
diff_midcurrent_tar$change <- mid_risk_tar_df$scaled_risk  - risk_tar_df$scaled_risk

# quin
diff_midcurrent_quin <- risk_quin_df
diff_midcurrent_quin$change <- mid_risk_quin_df$scaled_risk  - risk_quin_df$scaled_risk

## make absolute values
diff_maxval_pip <- max(abs(diff_midcurrent_pip$change), na.rm = TRUE)
diff_maxval_tar <- max(abs(diff_midcurrent_tar$change), na.rm = TRUE)
diff_maxval_quin <- max(abs(diff_midcurrent_quin$change), na.rm = TRUE)


## calculate difference from current to late century
# pip
diff_latecurrent_pip <- risk_pip_df
diff_latecurrent_pip$change <- late_risk_pip_df$scaled_risk  - risk_pip_df$scaled_risk

#tar
diff_latecurrent_tar <- risk_tar_df
diff_latecurrent_tar$change <- late_risk_tar_df$scaled_risk  - risk_tar_df$scaled_risk

# quin
diff_latecurrent_quin <- risk_quin_df
diff_latecurrent_quin$change <- late_risk_quin_df$scaled_risk  - risk_quin_df$scaled_risk



### create mean max absolute change across all years
all_changes <- c(
  diff_midcurrent_pip$change,
  diff_midcurrent_tar$change,
  diff_midcurrent_quin$change,
  diff_latecurrent_pip$change,
  diff_latecurrent_tar$change,
  diff_latecurrent_quin$change)

change_max_abs <- max(abs(all_changes), na.rm = TRUE)


## try another way
diff_maxval_pip <- max(abs(diff_midcurrent_pip$change), na.rm = TRUE)
diff_maxval_tar <- max(abs(diff_midcurrent_tar$change), na.rm = TRUE)
diff_maxval_quin <- max(abs(diff_midcurrent_quin$change), na.rm = TRUE)

```

plot it
```{r}

## pip
risk_pip_map <- ggplot() +
  geom_raster(data = risk_pip_df, aes(x = x, y = y, fill = scaled_risk)) +
  scale_fill_gradientn(colors = paletteer_c("ggthemes::Green", 30), #rev( SunsetDark Emrld
                      
                       na.value = "grey95",
                       limits = c(0, scaled_risk_max_abs),
                       oob = scales::squish,
                       name = "Scaled\n Risk")+
  #coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),  
        legend.spacing.x = unit(0.3, "cm"),
        
        plot.margin = margin(0,0,0,0))  +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) 


## tar
risk_tar_map <- ggplot() +
  geom_raster(data = risk_tar_df, aes(x = x, y = y, fill = scaled_risk)) +
  scale_fill_gradientn(colors = paletteer_c("ggthemes::Green", 30),
                      
                       na.value = "grey95",
                       limits = c(0, scaled_risk_max_abs),
                       oob = scales::squish,
                       name = "Scaled\n Risk")+
  #coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),  
        legend.spacing.x = unit(0.3, "cm"),
        
        plot.margin = margin(0,0,0,0))  +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) 


## quin
risk_quin_map <- ggplot() +
  geom_raster(data = risk_quin_df, aes(x = x, y = y, fill = scaled_risk)) +
  scale_fill_gradientn(colors = paletteer_c("ggthemes::Green", 30),
                      
                       na.value = "grey95",
                       limits = c(0, scaled_risk_max_abs),
                       oob = scales::squish,
                       name = "Scaled\n Risk")+
  #coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),  
        legend.spacing.x = unit(0.3, "cm"),
        
        plot.margin = margin(0,0,0,0))  +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) 


```

combine them
```{r}
risk_all_map <- ggarrange(risk_pip_map, risk_tar_map, risk_quin_map, 
          align = "hv", ncol = 1,
          common.legend = TRUE, legend = "bottom")

risk_all_map_an <- annotate_figure(risk_all_map,
                                   top = text_grob("(a) Current",
                                                   face = "bold", size = 14, hjust = 0, x = 0))

fig_3_a <- ggdraw(risk_all_map_an) +
  draw_plot_label(label = "Cx. pipiens", x = .0008, y = 0.69, angle = 90, size = 14, fontface = "bold") +
  draw_plot_label(label = "Cx. tarsalis", x = 0.008, y = 0.39, angle = 90, size = 14, fontface = "bold") +
  draw_plot_label(label = "Cx. quinq", x = 0.008, y = 0.11, angle = 90, size = 14, fontface = "bold")

ggsave(fig_3_a, file = "output/figures/fig_3_a.png",
       width = 4, height = 6.5, dpi = 300,
       units = "in", bg = "white")
```

Now make change in risk

```{r}

## pip
changerisk_pip_map <- ggplot() +
  geom_raster(data = diff_midcurrent_pip, aes(x = x, y = y, fill = change)) +
  scale_fill_gradient2(low = "#004586", #"#0072B5",
                       mid = "white",
                       high = "#DC3912",#"#BC3C29",
                       midpoint = 0,
                      
                       na.value = "grey95",
                       limits = c(-diff_maxval_pip, diff_maxval_pip),
                       #limits = c(-change_max_abs, change_max_abs),
                       #limits = c(-diff_maxval_pip, diff_maxval_pip),
                       breaks = scales::pretty_breaks(n = 2),
                       oob = scales::squish,
                       name = "Change\nin Risk")+
  #coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),  
        legend.spacing.x = unit(0.3, "cm"),
        
        plot.margin = margin(0,0,0,0))  +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) 

## tar
changerisk_tar_map <- ggplot() +
  geom_raster(data = diff_midcurrent_tar, aes(x = x, y = y, fill = change)) +
  scale_fill_gradient2(low = "#004586", #"#0072B5",
                       mid = "white",
                       high = "#DC3912",#"#BC3C29",
                       midpoint = 0,
                      
                       na.value = "grey95",
                       limits = c(-diff_maxval_tar, diff_maxval_tar),
                       #limits = c(-change_max_abs, change_max_abs),
                       #limits = c(-diff_maxval_tar, diff_maxval_tar),
                       breaks = scales::pretty_breaks(n = 2),
                       oob = scales::squish,
                       name = "Change\nin Risk")+
  #coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),  
        legend.spacing.x = unit(0.3, "cm"),
        
        plot.margin = margin(0,0,0,0))  +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) 

## quin
changerisk_quin_map <- ggplot() +
  geom_raster(data = diff_midcurrent_quin, aes(x = x, y = y, fill = change)) +
  scale_fill_gradient2(low = "#004586", #"#0072B5",
                       mid = "white",
                       high = "#DC3912",#"#BC3C29",
                       midpoint = 0,
                      
                       na.value = "grey95",
                       limits = c(-diff_maxval_quin, diff_maxval_quin),
                       #limits = c(-change_max_abs, change_max_abs),
                       #limits = c(-diff_maxval_quin, diff_maxval_quin),
                       breaks = scales::pretty_breaks(n = 2),
                       oob = scales::squish,
                       name = "Change\nin Risk")+
  #coord_fixed() +
  theme_void() +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  labs(title = "") +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 25, margin = margin(b = -10)),
        
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),  
        legend.spacing.x = unit(0.3, "cm"),
        
        plot.margin = margin(0,0,0,0))  +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) 

```

combine them
```{r}
changerisk_all_map <- ggarrange(changerisk_pip_map, changerisk_tar_map, changerisk_quin_map, 
          align = "hv", ncol = 1,
          common.legend = TRUE, legend = "bottom")

changerisk_all_map_an <- annotate_figure(changerisk_all_map,
                                   top = text_grob("(b) Mid-Century",
                                                   face = "bold", size = 14, hjust = 0, x = 0))

# fig_3_a <- ggdraw(risk_all_map_an) +
#   draw_plot_label(label = "Cx. pipiens", x = .0008, y = 0.69, angle = 90, size = 14, fontface = "bold") +
#   draw_plot_label(label = "Cx. tarsalis", x = 0.008, y = 0.39, angle = 90, size = 14, fontface = "bold") +
#   draw_plot_label(label = "Cx. quinq", x = 0.008, y = 0.11, angle = 90, size = 14, fontface = "bold")

ggsave(changerisk_all_map_an, file = "output/figures/fig_3_b.png",
       width = 4, height = 6.5, dpi = 300,
       units = "in", bg = "white")

```




#Fig 2 (move up)
mod_best_scaled <- gam(log_incidence ~
                         #climate 
                         s(scale_peakmonths_rR0_mean) +
                         
                         # landscape
                         s(scale_log_edgedensity_mk2) +
                         
                         # human
                         scale_bls_agemploy +
                         s(scale_svi_mean) + 
                         
                         # bird
                         scale_birds_tot +
                         
                         # controls
                         scale_perc_over65 +
                         s(lon, lat, bs = "gp"), 
                       
                       data = gam_covariates_full,
                       method = "REML")
                       
                       
Format data
```{r}
## aesthetics
theme_gam_fig <- theme_classic(base_size = 15) +
    theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    plot.margin = margin(0, 0, 0, 0)) 

## smooth estimates
sm_df_r0 <- smooth_estimates(mod_best_scaled, term = "s(scale_peakmonths_rR0_mean)")
sm_df_edge <- smooth_estimates(mod_best_scaled, term = "s(scale_log_edgedensity_mk2)")
sm_df_svi <- smooth_estimates(mod_best_scaled, term = "s(scale_svi_mean)")

## unscale them
# r0
mean_r0 <- mean(gam_covariates_full$raw_peakmonths_rR0_mean, na.rm = TRUE)
sd_r0 <- sd(gam_covariates_full$raw_peakmonths_rR0_mean, na.rm = TRUE)
sm_df_r0$raw_peakmonths_rR0_mean_unscaled <- sm_df_r0$scale_peakmonths_rR0_mean * sd_r0 + mean_r0

# edge
mean_edge <- mean(gam_covariates_full$raw_log_edgedensity_mk2, na.rm = TRUE)
sd_edge <- sd(gam_covariates_full$raw_log_edgedensity_mk2, na.rm = TRUE)
sm_df_edge$raw_log_edgedensity_mk2_unscaled <- sm_df_edge$scale_log_edgedensity_mk2 * sd_edge + mean_edge

# svi
mean_svi <- mean(gam_covariates_full$raw_svi_mean, na.rm = TRUE)
sd_svi <- sd(gam_covariates_full$raw_svi_mean, na.rm = TRUE)
sm_df_svi$raw_svi_mean_unscaled <- sm_df_svi$scale_svi_mean * sd_svi + mean_svi


```



non-linear plot
```{r}
smooth_unscaled_r0 <- ggplot(sm_df_r0, aes(x = raw_peakmonths_rR0_mean_unscaled, y = .estimate)) +
  geom_line(color = "#0073C2", size = 1.2) +
  geom_ribbon(aes(ymin = .estimate - .se, ymax = .estimate + .se), fill = "#0073C2", alpha = 0.2) +
  labs(x = "Average rR0", y = "Partial Effect on WNVND", title = "") +
  theme_gam_fig +
  ylim(-2,2) + scale_x_continuous(expand = c(0,0)) 

smooth_unscaled_edge <- ggplot(sm_df_edge, aes(x = raw_log_edgedensity_mk2_unscaled, y = .estimate)) +
  geom_line(color = "#0073C2", size = 1.2) +
  geom_ribbon(aes(ymin = .estimate - .se, ymax = .estimate + .se), fill = "#0073C2", alpha = 0.2) +
  labs(x = "Urban-Age Edge Density", y = "Partial Effect on WNVND", title = "") +
  theme_gam_fig +
  ylim(-.5,.5) + scale_x_continuous(expand = c(0,0)) 


smooth_unscaled_svi <- ggplot(sm_df_svi, aes(x = raw_svi_mean_unscaled, y = .estimate)) +
  geom_line(color = "#0073C2", size = 1.2) +
  geom_ribbon(aes(ymin = .estimate - .se, ymax = .estimate + .se), fill = "#0073C2", alpha = 0.2) +
  labs(x = "Socal Vulnerability Index", y = "Partial Effect on WNVND", title = "") +
  theme_gam_fig +
  ylim(-.15,.4) + scale_x_continuous(expand = c(0,0)) 
```

ag worker
```{r}
# Updated model and data
model <- mod_best_scaled
df <- gam_covariates_full

# Variable names - update to your actual scaled and unscaled variable names
scaled_var <- "scale_bls_agemploy"  # scaled variable name in model
unscaled_var <- "raw_bls_agemploy"      # original variable in data

# Extract coefficient and standard error for the linear term
# For parametric (linear) terms, they're in p.table
coef_summary <- summary(model)$p.table

# Check row names to confirm variable names match exactly
print(rownames(coef_summary))  

coef_est <- coef_summary[scaled_var, "Estimate"]
coef_se <- coef_summary[scaled_var, "Std. Error"]

# Calculate mean and sd from unscaled variable in data
mean_unscaled <- mean(df[[unscaled_var]], na.rm = TRUE)
sd_unscaled <- sd(df[[unscaled_var]], na.rm = TRUE)

# Create sequence of unscaled values for plotting
x_unscaled <- seq(min(df[[unscaled_var]], na.rm = TRUE),
                  max(df[[unscaled_var]], na.rm = TRUE),
                  length.out = 100)

# Scale unscaled values for model input
x_scaled <- (x_unscaled - mean_unscaled) / sd_unscaled

# Calculate partial effect and confidence intervals (linear effect)
fit <- coef_est * x_scaled
fit_low <- (coef_est - 1.96 * coef_se) * x_scaled
fit_high <- (coef_est + 1.96 * coef_se) * x_scaled

# Create dataframe for plotting
plot_df <- data.frame(
  x_unscaled = x_unscaled,
  fit = fit,
  fit_low = fit_low,
  fit_high = fit_high
)

# Plot linear partial effect

smooth_unscaled_employment <- 
  ggplot(plot_df, aes(x = x_unscaled, y = fit)) +
  geom_line(color = "#0073C2", linewidth = 1.2) +      # use linewidth, not size
  geom_ribbon(aes(ymin = fit_low, ymax = fit_high), fill = "#0073C2", alpha = 0.2) +
  labs(
    x = "Prop. Employed in Ag",
    y = "Partial Effect on WNVND",
    title = ""
  ) +
  theme_gam_fig +
  ylim(-.1, 1.9) +
  scale_x_continuous(expand = c(0, 0))


```

total birds
```{r}
# Updated model and data
model <- mod_best_scaled
df <- gam_covariates_full

# Variable names - update to your actual scaled and unscaled variable names
scaled_var <- "scale_birds_tot"  # scaled variable name in model
unscaled_var <- "raw_birds_tot"      # original variable in data

# Extract coefficient and standard error for the linear term
# For parametric (linear) terms, they're in p.table
coef_summary <- summary(model)$p.table

# Check row names to confirm variable names match exactly
print(rownames(coef_summary))  

coef_est <- coef_summary[scaled_var, "Estimate"]
coef_se <- coef_summary[scaled_var, "Std. Error"]

# Calculate mean and sd from unscaled variable in data
mean_unscaled <- mean(df[[unscaled_var]], na.rm = TRUE)
sd_unscaled <- sd(df[[unscaled_var]], na.rm = TRUE)

# Create sequence of unscaled values for plotting
x_unscaled <- seq(min(df[[unscaled_var]], na.rm = TRUE),
                  max(df[[unscaled_var]], na.rm = TRUE),
                  length.out = 100)

# Scale unscaled values for model input
x_scaled <- (x_unscaled - mean_unscaled) / sd_unscaled

# Calculate partial effect and confidence intervals (linear effect)
fit <- coef_est * x_scaled
fit_low <- (coef_est - 1.96 * coef_se) * x_scaled
fit_high <- (coef_est + 1.96 * coef_se) * x_scaled

# Create dataframe for plotting
plot_df <- data.frame(
  x_unscaled = x_unscaled,
  fit = fit,
  fit_low = fit_low,
  fit_high = fit_high
)

# Plot linear partial effect

smooth_unscaled_birds <- 
  ggplot(plot_df, aes(x = x_unscaled, y = fit)) +
  geom_line(color = "#0073C2", linewidth = 1.2) +      # use linewidth, not size
  geom_ribbon(aes(ymin = fit_low, ymax = fit_high), fill = "#0073C2", alpha = 0.2) +
  labs(
    x = "# Comp. Bird Species",
    y = "Partial Effect on WNVND",
    title = ""
  ) +
  theme_gam_fig +
  ylim(-.6, 1.6) +
  scale_x_continuous(expand = c(0, 0))


```

over 65
```{r}
# Updated model and data
model <- mod_best_scaled
df <- gam_covariates_full

# Variable names - update to your actual scaled and unscaled variable names
scaled_var <- "scale_perc_over65"  # scaled variable name in model
unscaled_var <- "raw_perc_over65"      # original variable in data

# Extract coefficient and standard error for the linear term
# For parametric (linear) terms, they're in p.table
coef_summary <- summary(model)$p.table

# Check row names to confirm variable names match exactly
print(rownames(coef_summary))  

coef_est <- coef_summary[scaled_var, "Estimate"]
coef_se <- coef_summary[scaled_var, "Std. Error"]

# Calculate mean and sd from unscaled variable in data
mean_unscaled <- mean(df[[unscaled_var]], na.rm = TRUE)
sd_unscaled <- sd(df[[unscaled_var]], na.rm = TRUE)

# Create sequence of unscaled values for plotting
x_unscaled <- seq(min(df[[unscaled_var]], na.rm = TRUE),
                  max(df[[unscaled_var]], na.rm = TRUE),
                  length.out = 100)

# Scale unscaled values for model input
x_scaled <- (x_unscaled - mean_unscaled) / sd_unscaled

# Calculate partial effect and confidence intervals (linear effect)
fit <- coef_est * x_scaled
fit_low <- (coef_est - 1.96 * coef_se) * x_scaled
fit_high <- (coef_est + 1.96 * coef_se) * x_scaled

# Create dataframe for plotting
plot_df <- data.frame(
  x_unscaled = x_unscaled,
  fit = fit,
  fit_low = fit_low,
  fit_high = fit_high
)

# Plot linear partial effect

smooth_unscaled_65 <- 
  ggplot(plot_df, aes(x = x_unscaled, y = fit)) +
  geom_line(color = "#0073C2", linewidth = 1.2) +      # use linewidth, not size
  geom_ribbon(aes(ymin = fit_low, ymax = fit_high), fill = "#0073C2", alpha = 0.2) +
  labs(
    x = "% of Pop. aged 65+",
    y = "Partial Effect on WNVND",
    title = ""
  ) +
  theme_gam_fig +
  ylim(-1, 3.5) +
  scale_x_continuous(expand = c(0, 0))

```


arrange them
```{r}
fig_2_arranged <- ggarrange(smooth_unscaled_r0 + rremove("ylab") + 
    annotate("text", x = -Inf, y = Inf, label = "Climate", hjust = -0.1, vjust = 1.5, size = 4, fontface = "italic"),
    
          smooth_unscaled_edge + rremove("ylab") + 
    annotate("text", x = -Inf, y = Inf, label = "Landscape", hjust = -0.1, vjust = 1.5, size = 4, fontface = "italic"),
    
          smooth_unscaled_employment + rremove("ylab") + 
    annotate("text", x = -Inf, y = Inf, label = "Human-Host", hjust = -0.1, vjust = 1.5, size = 4, fontface = "italic"),
    
          smooth_unscaled_svi + rremove("ylab") + 
    annotate("text", x = -Inf, y = Inf, label = "Human-Host", hjust = -0.1, vjust = 1.5, size = 4, fontface = "italic"),
    
        
          smooth_unscaled_65 + rremove("ylab") + 
    annotate("text", x = -Inf, y = Inf, label = "Demographic Control", hjust = -0.1, vjust = 1.1, size = 4, fontface = "italic"),
    
          smooth_unscaled_birds + rremove("ylab") + 
    annotate("text", x = -Inf, y = Inf, label = "Bird-Host", hjust = -0.1, vjust = 1.1, size = 4, fontface = "italic"),

    ncol = 2, nrow = 3,
  align = "hv", 
  labels = c("(a)", "(b)", "(c)", "(d)", "(e)" ,"(f)"),
  label.x = 0.01, label.y = 1.01,
  hjust = 0)

fig_2_arranged_an <- annotate_figure(fig_2_arranged,
                                     left = text_grob("Partial Effect on WNVND",
                                                 face = "bold", size = 16, rot = 90,
                                                  hjust = .5, vjust = 1.1,x = 0))

ggsave(fig_2_arranged_an, file = "output/figures/fig_2.png",
       width = 6.5, height = 6,
       dpi = 300,
       units = "in", bg = "white")
```




#Supplement


##ST2.1

GAM covariate distributions
```{r}

gam_covariates_sf <- counties_sf %>% 
  left_join(gam_covariates_full, by = "GEOID")

## WNV incidence
covariate_incidence <- ggplot(gam_covariates_sf) +
  geom_sf(aes(fill = raw_incidence), color = NA, size = 0.05, show.legend = TRUE) +
  scale_fill_viridis_c(option = "inferno", direction = -1,
                       na.value = "gray95",
                       limits = c(0, max(gam_covariates_sf$raw_incidence, na.rm = TRUE)),
                       guide = guide_colorbar(title.position = "top", title.hjust = 0.5),
                       oob = scales::squish) +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) +
  labs(title = "Average Annual WNV Incidence (1999-2023)", fill = "Incidence") +
  theme_void() +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 16, margin = margin(b = -10)),
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        plot.margin = margin(t = 1, r = -35, b = -1, l = 2))
  
ggsave(covariate_incidence, file = "output/figures/covariate_incidence.png",
       width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")


##rR0
covariate_rR0 <- ggplot(gam_covariates_sf) +
  geom_sf(aes(fill = raw_peakmonths_rR0_mean), color = NA, size = 0.05, show.legend = TRUE) +
  scale_fill_viridis_c(option = "inferno", direction = -1,
                       na.value = "gray95",
                       oob = scales::squish,
                       limits = c(0, max(gam_covariates_sf$raw_peakmonths_rR0_mean, na.rm = TRUE)),
                       guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) +
  labs(title = "Average Peak Season rR0", fill = "rR0") +
  theme_void() +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 16, margin = margin(b = -10)),
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),
        legend.spacing.x = unit(0.3, "cm"),
        plot.margin = margin(t = 1, r = -35, b = -1, l = 2))
  
ggsave(covariate_rR0, file = "output/figures/covariate_rR0.png",
       width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")

## edge density
covariate_edge <- ggplot(gam_covariates_sf) +
  geom_sf(aes(fill = raw_edgedensity_mk2), color = NA, size = 0.05, show.legend = TRUE) +
  scale_fill_viridis_c(option = "inferno", direction = -1,
                       na.value = "gray95",
                       oob = scales::squish,
                       limits = c(0, max(gam_covariates_sf$raw_edgedensity_mk2, na.rm = TRUE)),
                       guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) +
  labs(title = "Urban-Ag Edge Density (m/k2)", fill = "Density") +
  theme_void() +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 16, margin = margin(b = -10)),
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),
        legend.spacing.x = unit(0.3, "cm"),
        plot.margin = margin(t = 1, r = -35, b = -1, l = 2))
  
ggsave(covariate_edge, file = "output/figures/covariate_edge.png",
       width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")


## ag employment
covariate_ag <- ggplot(gam_covariates_sf) +
  geom_sf(aes(fill = raw_bls_agemploy), color = NA, size = 0.05, show.legend = TRUE) +
  scale_fill_viridis_c(option = "inferno", direction = -1,
                       na.value = "gray95",
                       oob = scales::squish,
                       limits = c(0, max(gam_covariates_sf$raw_bls_agemploy, na.rm = TRUE)),
                       guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) +
  labs(title = "Proportion of Population Employed in Ag", fill = "Proportion") +
  theme_void() +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 16, margin = margin(b = -10)),
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),
        legend.spacing.x = unit(0.3, "cm"),
        plot.margin = margin(t = 1, r = -35, b = -1, l = 2))
  
ggsave(covariate_ag, file = "output/figures/covariate_ag.png",
       width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")


## svi
covariate_svi <- ggplot(gam_covariates_sf) +
  geom_sf(aes(fill = raw_svi_mean), color = NA, size = 0.05, show.legend = TRUE) +
  scale_fill_viridis_c(option = "inferno", direction = -1,
                       na.value = "gray95",
                       oob = scales::squish,
                       limits = c(0, max(gam_covariates_sf$raw_svi_mean, na.rm = TRUE)),
                       guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) +
  labs(title = "Social Vulnerability Index", fill = "Index") +
  theme_void() +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 16, margin = margin(b = -10)),
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),
        legend.spacing.x = unit(0.3, "cm"),
        plot.margin = margin(t = 1, r = -35, b = -1, l = 2))
  
ggsave(covariate_svi, file = "output/figures/covariate_svi.png",
       width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")


## total birds
covariate_birds <- ggplot(gam_covariates_sf) +
  geom_sf(aes(fill = raw_birds_tot), color = NA, size = 0.05, show.legend = TRUE) +
  scale_fill_viridis_c(option = "inferno", direction = -1,
                       na.value = "gray95",
                       oob = scales::squish,
                       limits = c(0, max(gam_covariates_sf$raw_birds_tot, na.rm = TRUE)),
                       guide = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  geom_sf(data = states_sf, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = c(-125, -66.5), ylim = c(24, 50), expand = FALSE) +
  labs(title = "Total Competent Bird Species Present", fill = "Total") +
  theme_void() +
  theme(title = element_text(face = "bold"),
        plot.title.position = "panel",
        plot.title = element_text(size = 16, margin = margin(b = -10)),
        legend.position = "bottom",
        legend.title = element_text(face = "bold", size = 15),
        legend.text = element_text(size = 15, face = "bold"),
        legend.key.width = unit(1.2, "cm"),
        legend.spacing.x = unit(0.3, "cm"),
        plot.margin = margin(t = 1, r = -35, b = -1, l = 2))
  
ggsave(covariate_birds, file = "output/figures/covariate_birds.png",
       width = 11, height = 6.5, dpi = 300,
       units = "in", bg = "white")




```

GAM covariate correlations
```{r}
gam_covariates_slim <- gam_covariates_full %>% 
  dplyr::select(raw_incidence,
                raw_perc_over65,
                raw_log_edgedensity_mk2,
                raw_bls_agemploy,
                raw_svi_mean,
                raw_birds_tot,
                raw_peakmonths_rR0_mean)

cor_matrix <- cor(gam_covariates_slim, use = "complete.obs")

colnames(cor_matrix) <- c("rR0","Birds", "SVI", "Ag Employed", "Edge Density", ">65", "WNV Incidence")
rownames(cor_matrix) <- c("rR0","Birds", "SVI", "Ag Employed", "Edge Density", ">65", "WNV Incidence")
matrix_corrplot <- ggcorrplot(cor_matrix, 
           method = "square",     
           type = "upper",       
           lab = TRUE,        
           lab_size = 6, 
           show.legend =FALSE,
           tl.col = "black",        
           tl.srt = 45,
           colors = c( "#004586", "white", "#DC3912")) +
  theme_void() +
  theme(legend.position = c(.88,.3), #"bottom",
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 13),
        plot.title = element_text(hjust = 0, face = "bold", size = 14),
        axis.text = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(angle = 15, vjust = .9))

## really the only concerning one is rR0 and SVI but probably heat islands/high heat is part of the SVI metric

ggsave(matrix_corrplot, file = "output/figures/matrix_corrplot.png",
       width = 6.5, height = 6,
       dpi = 300,
       units = "in", bg = "white")
```

GAM diagnostics
```{r}
gam_diagnostic <- appraise(mod_best_scaled)

ggsave(gam_diagnostic, file = "output/figures/gam_diagnostic.png",
       width = 6.5, height = 6,
       dpi = 300,
       units = "in", bg = "white")
```


GAM partial dependence plots
```{r}

gam_pd <- draw(mod_best_scaled)

ggsave(gam_pd, file = "output/figures/gam_pd.png",
       width = 6.5, height = 6,
       dpi = 300,
       units = "in", bg = "white")
```